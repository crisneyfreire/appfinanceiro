<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Sistema Financeiro</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #333333;
            --text-secondary: #666666;
            --income: #4CAF50;
            --expense: #f44336;
            --accent: #4CAF50;
            --accent-hover: #45a049;
            --border: #dddddd;
            --card-bg: #ffffff;
            --shadow: rgba(0,0,0,0.1);
            --warning: #ff9800;
            --info: #2196F3;
        }

        .dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --income: #4CAF50;
            --expense: #f44336;
            --accent: #5C6BC0;
            --accent-hover: #3f51b5;
            --border: #404040;
            --card-bg: #2d2d2d;
            --shadow: rgba(0,0,0,0.3);
            --warning: #ff9800;
            --info: #64b5f6;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 10px 0;
        }

        .header h1 {
            font-size: 24px;
            color: var(--text-primary);
        }

        .dark-mode-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .dark-mode-toggle:hover {
            background: var(--accent);
            color: white;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .balance-card {
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px var(--shadow);
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .balance-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .balance-breakdown {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px var(--shadow);
        }

        .stat-title {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .stat-sub {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .form-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px var(--shadow);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group input, 
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab.active {
            color: white;
            border-color: currentColor;
        }

        .tab.income-tab.active {
            background: var(--income);
        }

        .tab.expense-tab.active {
            background: var(--expense);
        }

        .payment-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .payment-btn {
            padding: 10px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .payment-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-income {
            background: var(--income);
        }

        .btn-expense {
            background: var(--expense);
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .transactions-list {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px var(--shadow);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .list-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .list-filters select,
        .list-filters input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
            gap: 15px;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-header {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 5px;
        }

        .transaction-valor {
            font-weight: bold;
            font-size: 18px;
        }

        .transaction-valor.income {
            color: var(--income);
        }

        .transaction-valor.expense {
            color: var(--expense);
        }

        .transaction-categoria {
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 12px;
        }

        .transaction-conta {
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--info);
            color: white;
            font-size: 11px;
            opacity: 0.9;
        }

        .transaction-descricao {
            color: var(--text-primary);
            margin: 3px 0;
        }

        .transaction-detalhes {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .transaction-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s;
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background: var(--bg-secondary);
        }

        .action-btn.edit:hover {
            color: var(--info);
        }

        .action-btn.delete:hover {
            color: var(--expense);
        }

        .contas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .conta-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px var(--shadow);
            position: relative;
        }

        .conta-tipo {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            background: var(--info);
            color: white;
        }

        .conta-nome {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-right: 60px;
        }

        .conta-saldo {
            font-size: 24px;
            color: var(--income);
            margin-bottom: 10px;
        }

        .conta-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .orcamento-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .orcamento-select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
        }

        .orcamento-resumo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .orcamento-item {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .orcamento-header-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .relatorio-periodo {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .relatorio-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .relatorio-tabela {
            width: 100%;
            border-collapse: collapse;
        }

        .relatorio-tabela th,
        .relatorio-tabela td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .relatorio-tabela th {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Sistema Financeiro</h1>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()">
                üåô Modo Escuro
            </button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('lancamentos')">üìù Lan√ßamentos</button>
            <button class="nav-tab" onclick="showTab('contas')">üè¶ Contas</button>
            <button class="nav-tab" onclick="showTab('orcamento')">üìÖ Or√ßamento</button>
            <button class="nav-tab" onclick="showTab('relatorios')">üìà Relat√≥rios</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="balance-card">
                <div class="balance-label">Saldo Total</div>
                <div class="balance-value" id="saldoTotal">R$ 0,00</div>
                <div class="balance-breakdown">
                    <span class="balance-income" id="totalReceitas">üìà Receitas: R$ 0,00</span>
                    <span class="balance-expense" id="totalDespesas">üìâ Despesas: R$ 0,00</span>
                    <span id="totalPrevisto">üìÖ Previsto: R$ 0,00</span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">üí≥ Pagamentos (M√™s)</div>
                    <div class="stat-value" id="pagamentosMes">R$ 0,00</div>
                    <div class="stat-sub" id="pagamentosPrevistos">Previsto: R$ 0,00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">üì• Recebimentos (M√™s)</div>
                    <div class="stat-value" id="recebimentosMes">R$ 0,00</div>
                    <div class="stat-sub" id="recebimentosPrevistos">Previsto: R$ 0,00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">üí∞ Saldo em Contas</div>
                    <div class="stat-value" id="saldoContas">R$ 0,00</div>
                    <div class="stat-sub" id="totalContas">0 contas ativas</div>
                </div>
            </div>
        </div>

        <div id="lancamentos" class="tab-content">
            <div class="tabs">
                <button class="tab income-tab active" onclick="setTipoLancamento('receita')">üìà Receita</button>
                <button class="tab expense-tab" onclick="setTipoLancamento('despesa')">üìâ Despesa</button>
            </div>

            <div class="form-card">
                <div class="form-row">
                    <div class="form-group">
                        <label>üí∞ Valor (R$)</label>
                        <input type="text" id="valor" placeholder="0,00">
                    </div>
                    <div class="form-group">
                        <label>üìÖ Data</label>
                        <input type="date" id="dataLancamento">
                    </div>
                </div>

                <div class="form-group">
                    <label>üìù Descri√ß√£o</label>
                    <input type="text" id="descricao" placeholder="Ex: Sal√°rio, Supermercado">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>üìÇ Categoria</label>
                        <select id="categoria"></select>
                    </div>
                    <div class="form-group">
                        <label>üè¶ Conta</label>
                        <select id="contaSelect"></select>
                    </div>
                </div>

                <div id="pagamentoDiv">
                    <div style="margin-bottom: 15px;">
                        <label>üí≥ Pagamento/Recebimento</label>
                        <div class="payment-types">
                            <button class="payment-btn active" onclick="setPagamento('dinheiro')">üíµ Dinheiro</button>
                            <button class="payment-btn" onclick="setPagamento('debito')">üí≥ D√©bito</button>
                            <button class="payment-btn" onclick="setPagamento('credito')">üí≥ Cr√©dito</button>
                            <button class="payment-btn" onclick="setPagamento('credito_debito')">üí≥ Cr√©dito/D√©bito</button>
                            <button class="payment-btn" onclick="setPagamento('pix')">üì± Pix</button>
                            <button class="payment-btn" onclick="setPagamento('boleto')">üìÑ Boleto</button>
                            <button class="payment-btn" onclick="setPagamento('transferencia')">üîÑ Transfer√™ncia</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>üìù Observa√ß√µes</label>
                    <textarea id="observacao" rows="2" placeholder="Detalhes adicionais..."></textarea>
                </div>

                <button class="btn-primary btn-income" onclick="lancarTransacao()" id="btnLancar">
                    ‚ûï LAN√áAR
                </button>
            </div>

            <div class="transactions-list">
                <div class="list-header">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h3>üìã √öltimos Lan√ßamentos</h3>
                        <button class="action-btn edit" onclick="abrirGerenciarCategorias()" title="Gerenciar Categorias" style="padding: 8px 12px; background: var(--accent); color: white; border-radius: 6px;">
                            üìÇ Gerenciar Categorias
                        </button>
                    </div>
                    <div class="list-filters">
                        <select id="filtroMes" onchange="filtrarLancamentos()">
                            <option value="all">Todos os meses</option>
                        </select>
                        <select id="filtroConta" onchange="filtrarLancamentos()">
                            <option value="all">Todas as contas</option>
                        </select>
                    </div>
                </div>
                <div id="listaLancamentos"></div>
            </div>
        </div>

        <div id="contas" class="tab-content">
            <div class="form-card">
                <h3 style="margin-bottom: 20px;">‚ûï Nova Conta</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>üè¶ Nome da Conta</label>
                        <input type="text" id="nomeConta" placeholder="Ex: NuBank, Ita√∫, Carteira">
                    </div>
                    <div class="form-group">
                        <label>üí∞ Saldo Inicial</label>
                        <input type="text" id="saldoInicial" value="0,00">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>üìÇ Tipo</label>
                        <select id="tipoConta">
                            <option value="corrente">üí≥ Corrente</option>
                            <option value="poupanca">üí∞ Poupan√ßa</option>
                            <option value="dinheiro">üíµ Dinheiro F√≠sico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üé® Cor (opcional)</label>
                        <input type="color" id="corConta" value="#4CAF50">
                    </div>
                </div>
                <button class="btn-primary btn-income" onclick="adicionarConta()">‚ûï ADICIONAR CONTA</button>
            </div>

            <div class="contas-grid" id="listaContas"></div>
        </div>

        <div id="orcamento" class="tab-content">
            <div class="orcamento-header">
                <h3>üìÖ Or√ßamento Mensal</h3>
                <input type="month" id="mesOrcamento" class="orcamento-select" onchange="carregarOrcamento()">
            </div>

            <div class="orcamento-resumo">
                <div class="stat-card">
                    <div class="stat-title">üìà Receitas Previstas</div>
                    <div class="stat-value" id="totalReceitasPrevistas">R$ 0,00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">üìâ Despesas Previstas</div>
                    <div class="stat-value" id="totalDespesasPrevistas">R$ 0,00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">üí∞ Saldo Previsto</div>
                    <div class="stat-value" id="saldoPrevisto">R$ 0,00</div>
                </div>
            </div>

            <div class="form-card">
                <h4 style="margin-bottom: 15px;">‚ûï Nova Previs√£o</h4>
                <div class="tabs">
                    <button class="tab income-tab active" onclick="setTipoPrevisao('receita')">üìà Receita</button>
                    <button class="tab expense-tab" onclick="setTipoPrevisao('despesa')">üìâ Despesa</button>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>üí∞ Valor</label>
                        <input type="text" id="valorPrevisto" placeholder="0,00">
                    </div>
                    <div class="form-group">
                        <label>üìù Descri√ß√£o</label>
                        <input type="text" id="descricaoPrevista" placeholder="Ex: Sal√°rio, Aluguel">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>üìÇ Categoria</label>
                        <select id="categoriaPrevista"></select>
                    </div>
                    <div class="form-group">
                        <label>üìÖ Vencimento</label>
                        <input type="number" id="diaVencimento" min="1" max="31" placeholder="Dia do m√™s">
                    </div>
                </div>

                <button class="btn-primary btn-income" onclick="adicionarPrevisao()">‚ûï ADICIONAR PREVIS√ÉO</button>
            </div>

            <div class="transactions-list">
                <h4>üìã Previs√µes do M√™s</h4>
                <div id="listaPrevisoes"></div>
            </div>
        </div>

        <div id="relatorios" class="tab-content">
            <div class="relatorio-periodo">
                <select id="relatorioMes" onchange="gerarRelatorio()">
                    <option value="all">Todos os meses</option>
                </select>
                <select id="relatorioAno" onchange="gerarRelatorio()">
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                </select>
                <button class="btn-primary btn-income" onclick="gerarRelatorio()">üìä GERAR RELAT√ìRIO</button>
            </div>

            <div class="relatorio-card">
                <h4 style="margin-bottom: 20px;">üìä Resumo do Per√≠odo</h4>
                <div class="stats-grid" id="relatorioResumo"></div>
            </div>

            <div class="relatorio-card">
                <h4 style="margin-bottom: 20px;">üìã Detalhamento por Categoria</h4>
                <table class="relatorio-tabela" id="tabelaCategorias">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Receitas</th>
                            <th>Despesas</th>
                            <th>Saldo</th>
                        </tr>
                    </thead>
                    <tbody id="corpoTabelaCategorias"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO DO FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDQPz3wvkID4tmUHazT1aXew6fYzSbyL00",
            authDomain: "projeto-appfinanceiro.firebaseapp.com",
            projectId: "projeto-appfinanceiro",
            storageBucket: "projeto-appfinanceiro.firebasestorage.app",
            messagingSenderId: "1086361791636",
            appId: "1:1086361791636:web:b761c87d4a3d49984a5881",
            measurementId: "G-4LLMZ9QJSR"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ============================================
        // ESTRUTURA DE DADOS
        // ============================================
        let transacoes = [];
        let contas = [];
        let previsoes = [];
        let tipoLancamento = 'receita';
        let tipoPrevisao = 'receita';
        let pagamentoSelecionado = 'dinheiro';
        let editandoId = null;

        // ============================================
        // SISTEMA DE CATEGORIAS EDIT√ÅVEIS
        // ============================================
        let categorias = {
            receita: [
                'Sal√°rio',
                'Presta√ß√£o de Servi√ßo',
                'Freelance',
                'Investimentos',
                'Presente',
                'Venda',
                'Outros'
            ],
            despesa: [
                'Alimenta√ß√£o',
                'Transporte',
                'Sa√∫de',
                'Educa√ß√£o',
                'Lazer',
                'Moradia',
                'Contas',
                'Outros'
            ]
        };

        // Carregar categorias do Firebase
        async function carregarCategoriasFirebase() {
            try {
                const docRef = db.collection('dados_usuario').doc('categorias');
                const docSnap = await docRef.get();
                
                if (docSnap.exists) {
                    const dados = docSnap.data();
                    if (dados.receita && dados.despesa) {
                        categorias = dados;
                    }
                }
                await salvarCategoriasFirebase();
            } catch (error) {
                console.log('Erro ao carregar categorias:', error);
                carregarCategoriasLocal();
            }
        }

        async function salvarCategoriasFirebase() {
            try {
                await db.collection('dados_usuario').doc('categorias').set({
                    receita: categorias.receita,
                    despesa: categorias.despesa,
                    ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.log('Erro ao salvar categorias:', error);
            }
        }

        function carregarCategoriasLocal() {
            const catsSalvas = localStorage.getItem('categorias');
            if (catsSalvas) {
                categorias = JSON.parse(catsSalvas);
            }
        }

        function salvarCategorias() {
            localStorage.setItem('categorias', JSON.stringify(categorias));
            salvarCategoriasFirebase();
        }

        // Modal de gerenciamento de categorias
        function abrirGerenciarCategorias() {
            const modal = document.createElement('div');
            modal.className = 'modal-categorias';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üìÇ Gerenciar Categorias</h3>
                        <button onclick="this.closest('.modal-categorias').remove()" class="close-btn">‚úñ</button>
                    </div>
                    <div class="modal-body">
                        <div class="categoria-tabs">
                            <button class="categoria-tab active" onclick="mudarTabCategoria('receita', this)">üìà Receitas</button>
                            <button class="categoria-tab" onclick="mudarTabCategoria('despesa', this)">üìâ Despesas</button>
                        </div>
                        
                        <div id="categoria-receita" class="categoria-list active">
                            ${categorias.receita.map((cat, index) => `
                                <div class="categoria-item">
                                    <span>${cat}</span>
                                    <div>
                                        <button onclick="editarCategoria('receita', ${index}, '${cat}')" class="edit-btn">‚úèÔ∏è</button>
                                        ${cat !== 'Outros' ? `<button onclick="deletarCategoria('receita', ${index})" class="delete-btn">üóëÔ∏è</button>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div id="categoria-despesa" class="categoria-list">
                            ${categorias.despesa.map((cat, index) => `
                                <div class="categoria-item">
                                    <span>${cat}</span>
                                    <div>
                                        <button onclick="editarCategoria('despesa', ${index}, '${cat}')" class="edit-btn">‚úèÔ∏è</button>
                                        ${cat !== 'Outros' ? `<button onclick="deletarCategoria('despesa', ${index})" class="delete-btn">üóëÔ∏è</button>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="nova-categoria">
                            <h4>‚ûï Nova Categoria</h4>
                            <div class="form-group">
                                <input type="text" id="novaCategoriaNome" placeholder="Nome da categoria">
                                <select id="novaCategoriaTipo">
                                    <option value="receita">Receita</option>
                                    <option value="despesa">Despesa</option>
                                </select>
                                <button onclick="adicionarCategoria()" class="btn-primary btn-income">ADICIONAR</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Adicionar CSS do modal
            const style = document.createElement('style');
            style.textContent = `
                .modal-categorias {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                }
                .modal-content {
                    background: var(--bg-primary);
                    border-radius: 15px;
                    padding: 20px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                }
                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                }
                .close-btn {
                    background: none;
                    border: none;
                    font-size: 20px;
                    cursor: pointer;
                    color: var(--text-primary);
                }
                .categoria-tabs {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 20px;
                }
                .categoria-tab {
                    flex: 1;
                    padding: 10px;
                    border: 1px solid var(--border);
                    background: var(--bg-secondary);
                    color: var(--text-primary);
                    border-radius: 8px;
                    cursor: pointer;
                }
                .categoria-tab.active {
                    background: var(--accent);
                    color: white;
                }
                .categoria-list {
                    display: none;
                    margin-bottom: 20px;
                }
                .categoria-list.active {
                    display: block;
                }
                .categoria-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px;
                    border-bottom: 1px solid var(--border);
                }
                .nova-categoria {
                    margin-top: 20px;
                    padding: 20px;
                    background: var(--bg-secondary);
                    border-radius: 10px;
                }
                .nova-categoria .form-group {
                    display: flex;
                    gap: 10px;
                    flex-wrap: wrap;
                }
                .nova-categoria input,
                .nova-categoria select {
                    flex: 1;
                    min-width: 150px;
                }
                .edit-btn, .delete-btn {
                    background: none;
                    border: none;
                    font-size: 16px;
                    cursor: pointer;
                    padding: 5px;
                    border-radius: 4px;
                }
                .edit-btn:hover {
                    background: var(--info);
                    color: white;
                }
                .delete-btn:hover {
                    background: var(--expense);
                    color: white;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(modal);
        }

        function mudarTabCategoria(tipo, element) {
            document.querySelectorAll('.categoria-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.categoria-list').forEach(l => l.classList.remove('active'));
            
            element.classList.add('active');
            document.getElementById(`categoria-${tipo}`).classList.add('active');
        }

        function adicionarCategoria() {
            const nome = document.getElementById('novaCategoriaNome').value.trim();
            const tipo = document.getElementById('novaCategoriaTipo').value;

            if (!nome) {
                alert('Digite um nome para a categoria!');
                return;
            }

            if (categorias[tipo].includes(nome)) {
                alert('Esta categoria j√° existe!');
                return;
            }

            categorias[tipo].push(nome);
            salvarCategorias();
            
            // Atualizar selects em todas as telas
            preencherCategorias();
            preencherCategoriasPrevisao();
            
            // Fechar modal
            document.querySelector('.modal-categorias').remove();
            
            // Mostrar mensagem de sucesso
            alert('‚úÖ Categoria adicionada com sucesso!');
        }

        function editarCategoria(tipo, index, nomeAtual) {
            const novoNome = prompt('Editar categoria:', nomeAtual);
            
            if (novoNome && novoNome.trim()) {
                if (categorias[tipo].includes(novoNome.trim()) && novoNome.trim() !== nomeAtual) {
                    alert('Esta categoria j√° existe!');
                    return;
                }
                
                categorias[tipo][index] = novoNome.trim();
                salvarCategorias();
                
                // Atualizar transa√ß√µes existentes
                transacoes.forEach(t => {
                    if (t.categoria === nomeAtual) {
                        t.categoria = novoNome.trim();
                    }
                });
                
                preencherCategorias();
                preencherCategoriasPrevisao();
                atualizarListaLancamentos();
                salvarDados();
                
                alert('‚úÖ Categoria atualizada!');
            }
        }

        function deletarCategoria(tipo, index) {
            if (categorias[tipo][index] === 'Outros') {
                alert('A categoria "Outros" n√£o pode ser removida!');
                return;
            }

            if (confirm(`Remover categoria "${categorias[tipo][index]}"?`)) {
                const categoriaRemovida = categorias[tipo][index];
                
                // Substituir nas transa√ß√µes existentes
                transacoes.forEach(t => {
                    if (t.categoria === categoriaRemovida) {
                        t.categoria = 'Outros';
                    }
                });
                
                categorias[tipo].splice(index, 1);
                salvarCategorias();
                salvarDados();
                
                preencherCategorias();
                preencherCategoriasPrevisao();
                atualizarListaLancamentos();
                
                alert('‚úÖ Categoria removida!');
            }
        }

        // ============================================
        // FORMATA√á√ÉO DE MOEDA BRASILEIRA
        // ============================================
        function formatarMoeda(input) {
            let valor = input.value.replace(/\D/g, '');
            
            if (valor === '') {
                input.value = '';
                return;
            }
            
            // Converter para centavos
            valor = parseInt(valor) / 100;
            
            // Formatar como moeda brasileira
            input.value = valor.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function converterMoedaParaNumber(valorString) {
            if (!valorString) return 0;
            
            // Remover pontos de milhar e substituir v√≠rgula por ponto
            const valorLimpo = valorString
                .replace(/\./g, '')  // Remove pontos (milhar)
                .replace(',', '.');   // Substitui v√≠rgula por ponto
            
            return parseFloat(valorLimpo) || 0;
        }

        // ============================================
        // FUN√á√ïES DE SINCRONIZA√á√ÉO FIREBASE
        // ============================================
        
        function carregarDadosFirebase() {
            try {
                // Listener para dados principais
                db.collection('dados_usuario').doc('usuario_atual')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const dados = doc.data();
                            let dadosAlterados = false;
                            
                            if (dados.transacoes) {
                                transacoes = dados.transacoes;
                                dadosAlterados = true;
                            }
                            if (dados.contas) {
                                contas = dados.contas;
                                dadosAlterados = true;
                            }
                            if (dados.previsoes) {
                                previsoes = dados.previsoes;
                                dadosAlterados = true;
                            }
                            
                            if (dadosAlterados) {
                                console.log('üîÑ Dados atualizados da nuvem!');
                                salvarDadosLocal(); // Backup local
                                atualizarTela();
                            }
                        } else {
                            console.log('üìÅ Primeiro acesso - criando dados na nuvem');
                            salvarDadosFirebase();
                        }
                    }, (error) => {
                        console.log('‚ö†Ô∏è Erro no listener Firebase:', error);
                        carregarDadosLocal();
                        atualizarTela();
                    });

                // Listener para categorias
                db.collection('dados_usuario').doc('categorias')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const dados = doc.data();
                            if (dados.receita && dados.despesa) {
                                categorias = dados;
                                salvarCategoriasLocal();
                                
                                // Atualizar selects se necess√°rio
                                if (document.getElementById('lancamentos').classList.contains('active')) {
                                    preencherCategorias();
                                }
                                if (document.getElementById('orcamento').classList.contains('active')) {
                                    preencherCategoriasPrevisao();
                                }
                            }
                        }
                    }, (error) => {
                        console.log('Erro no listener de categorias:', error);
                    });

            } catch (error) {
                console.log('‚ö†Ô∏è Erro ao configurar Firebase:', error);
                carregarDadosLocal();
                atualizarTela();
            }
        }

        // Fun√ß√µes de backup local
        function salvarDadosLocal() {
            localStorage.setItem('transacoes', JSON.stringify(transacoes));
            localStorage.setItem('contas', JSON.stringify(contas));
            localStorage.setItem('previsoes', JSON.stringify(previsoes));
        }

        function salvarCategoriasLocal() {
            localStorage.setItem('categorias', JSON.stringify(categorias));
        }

        async function salvarDadosFirebase() {
            try {
                await db.collection('dados_usuario').doc('usuario_atual').set({
                    transacoes: transacoes,
                    contas: contas,
                    previsoes: previsoes,
                    ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Dados sincronizados com a nuvem!');
            } catch (error) {
                console.log('‚ö†Ô∏è Erro ao salvar na nuvem:', error);
            }
        }

        function salvarDados() {
            // Salvar local (backup)
            salvarDadosLocal();
            
            // Salvar na nuvem
            salvarDadosFirebase();
        }

        function carregarDadosLocal() {
            const transacoesSalvas = localStorage.getItem('transacoes');
            const contasSalvas = localStorage.getItem('contas');
            const previsoesSalvas = localStorage.getItem('previsoes');

            if (transacoesSalvas) transacoes = JSON.parse(transacoesSalvas);
            if (contasSalvas) contas = JSON.parse(contasSalvas);
            if (previsoesSalvas) previsoes = JSON.parse(previsoesSalvas);

            if (contas.length === 0) {
                contas.push({
                    id: 1,
                    nome: 'Carteira',
                    tipo: 'dinheiro',
                    saldoInicial: 0,
                    cor: '#4CAF50'
                });
            }
        }

        function carregarDados() {
            carregarDadosFirebase();
            carregarCategoriasFirebase();
        }

        // ============================================
        // FUN√á√ïES DE NAVEGA√á√ÉO
        // ============================================
        function showTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Encontrar o bot√£o clicado
            const botoes = document.querySelectorAll('.nav-tab');
            botoes.forEach(btn => {
                if (btn.textContent.includes(tabName === 'dashboard' ? 'üìä' : 
                                             tabName === 'lancamentos' ? 'üìù' :
                                             tabName === 'contas' ? 'üè¶' :
                                             tabName === 'orcamento' ? 'üìÖ' : 'üìà')) {
                    btn.classList.add('active');
                }
            });
            
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'lancamentos') {
                preencherCategorias();
                preencherSelectContas();
                preencherFiltros();
                atualizarListaLancamentos();
            } else if (tabName === 'orcamento') {
                preencherCategoriasPrevisao();
                carregarOrcamento();
            } else if (tabName === 'contas') {
                atualizarListaContas();
            } else if (tabName === 'dashboard') {
                atualizarDashboard();
            } else if (tabName === 'relatorios') {
                preencherSelectMeses();
                gerarRelatorio();
            }
        }

        function setTipoLancamento(tipo) {
            tipoLancamento = tipo;
            document.querySelectorAll('#lancamentos .tab').forEach(t => t.classList.remove('active'));
            
            if (tipo === 'receita') {
                document.querySelector('#lancamentos .income-tab').classList.add('active');
                document.getElementById('btnLancar').classList.remove('btn-expense');
                document.getElementById('btnLancar').classList.add('btn-income');
                document.getElementById('pagamentoDiv').style.display = 'block';
            } else {
                document.querySelector('#lancamentos .expense-tab').classList.add('active');
                document.getElementById('btnLancar').classList.remove('btn-income');
                document.getElementById('btnLancar').classList.add('btn-expense');
                document.getElementById('pagamentoDiv').style.display = 'block';
            }
            preencherCategorias();
        }

        function setTipoPrevisao(tipo) {
            tipoPrevisao = tipo;
            document.querySelectorAll('#orcamento .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            preencherCategoriasPrevisao();
        }

        function setPagamento(tipo) {
            pagamentoSelecionado = tipo;
            
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ============================================
        // FUN√á√ïES DE LAN√áAMENTOS
        // ============================================
        function preencherCategorias() {
            const select = document.getElementById('categoria');
            if (!select) return;
            
            select.innerHTML = '';
            categorias[tipoLancamento].forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }

        function preencherSelectContas() {
            const select = document.getElementById('contaSelect');
            if (!select) return;
            
            select.innerHTML = '';
            contas.forEach(conta => {
                const option = document.createElement('option');
                option.value = conta.id;
                option.textContent = `${conta.nome} (${conta.tipo})`;
                select.appendChild(option);
            });
        }

        async function lancarTransacao() {
            const valorInput = document.getElementById('valor').value;
            const descricao = document.getElementById('descricao').value;
            const categoria = document.getElementById('categoria').value;
            const contaId = parseInt(document.getElementById('contaSelect').value);
            const observacao = document.getElementById('observacao').value;
            let data = document.getElementById('dataLancamento').value;

            // Validar se h√° contas cadastradas
            if (contas.length === 0) {
                alert('‚ö†Ô∏è Cadastre uma conta primeiro!');
                showTab('contas');
                return;
            }

            const valorNumerico = converterMoedaParaNumber(valorInput);

            if (!valorNumerico || valorNumerico <= 0) {
                alert('Digite um valor v√°lido!');
                return;
            }

            if (!descricao) {
                alert('Digite uma descri√ß√£o!');
                return;
            }

            if (!data) {
                data = new Date().toISOString().split('T')[0];
            }

            const novaTransacao = {
                id: editandoId || Date.now(),
                tipo: tipoLancamento,
                valor: valorNumerico,
                descricao: descricao,
                categoria: categoria,
                contaId: contaId,
                pagamento: pagamentoSelecionado,
                observacao: observacao,
                data: data
            };

            if (editandoId) {
                const index = transacoes.findIndex(t => t.id === editandoId);
                if (index !== -1) {
                    transacoes[index] = novaTransacao;
                }
                editandoId = null;
            } else {
                transacoes.unshift(novaTransacao);
            }

            // Salvar no Firebase (isso vai disparar o listener em todos os dispositivos)
            await salvarDadosFirebase();
            salvarDadosLocal();
            
            // Limpar formul√°rio
            document.getElementById('valor').value = '';
            document.getElementById('descricao').value = '';
            document.getElementById('observacao').value = '';
            document.getElementById('dataLancamento').value = new Date().toISOString().split('T')[0];
            
            // Atualizar UI local
            atualizarListaLancamentos();
            atualizarDashboard();
            
            alert(editandoId ? '‚úÖ Lan√ßamento atualizado!' : '‚úÖ Lan√ßamento realizado!');
        }

        function editarTransacao(id) {
            const transacao = transacoes.find(t => t.id === id);
            if (!transacao) return;

            editandoId = id;
            
            if (transacao.tipo === 'receita') {
                setTipoLancamento('receita');
                document.querySelector('#lancamentos .income-tab').click();
            } else {
                setTipoLancamento('despesa');
                document.querySelector('#lancamentos .expense-tab').click();
            }

            document.getElementById('valor').value = transacao.valor.toFixed(2).replace('.', ',');
            document.getElementById('descricao').value = transacao.descricao;
            document.getElementById('categoria').value = transacao.categoria;
            document.getElementById('contaSelect').value = transacao.contaId;
            document.getElementById('observacao').value = transacao.observacao || '';
            
            if (transacao.data) {
                document.getElementById('dataLancamento').value = transacao.data;
            }

            pagamentoSelecionado = transacao.pagamento || 'dinheiro';
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(pagamentoSelecionado)) {
                    btn.classList.add('active');
                }
            });

            showTab('lancamentos');
        }

        function deletarTransacao(id) {
            if (confirm('Tem certeza que deseja excluir?')) {
                transacoes = transacoes.filter(t => t.id !== id);
                salvarDados();
                atualizarListaLancamentos();
                atualizarDashboard();
            }
        }

        function atualizarListaLancamentos() {
            const listaDiv = document.getElementById('listaLancamentos');
            if (!listaDiv) return;

            const filtroMes = document.getElementById('filtroMes')?.value || 'all';
            const filtroConta = document.getElementById('filtroConta')?.value || 'all';

            let transacoesFiltradas = [...transacoes];

            if (filtroMes !== 'all') {
                transacoesFiltradas = transacoesFiltradas.filter(t => {
                    const data = new Date(t.data);
                    return data.getMonth() === parseInt(filtroMes);
                });
            }

            if (filtroConta !== 'all') {
                transacoesFiltradas = transacoesFiltradas.filter(t => t.contaId === parseInt(filtroConta));
            }

            if (transacoesFiltradas.length === 0) {
                listaDiv.innerHTML = '<div class="empty-state">üïí Nenhum lan√ßamento encontrado</div>';
                return;
            }

            let html = '';
            transacoesFiltradas.forEach(t => {
                const conta = contas.find(c => c.id === t.contaId) || { nome: 'Conta' };
                
                const icones = {
                    'dinheiro': 'üíµ',
                    'debito': 'üí≥',
                    'credito': 'üí≥',
                    'credito_debito': 'üí≥',
                    'pix': 'üì±',
                    'boleto': 'üìÑ',
                    'transferencia': 'üîÑ'
                };
                
                html += `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-header">
                                <span class="transaction-valor ${t.tipo}">
                                    ${t.tipo === 'receita' ? '+' : '-'} R$ ${t.valor.toFixed(2).replace('.', ',')}
                                </span>
                                <span class="transaction-categoria">${t.categoria}</span>
                                <span class="transaction-conta">${conta.nome}</span>
                            </div>
                            <div class="transaction-descricao">${t.descricao}</div>
                            <div class="transaction-detalhes">
                                ${t.pagamento ? `${icones[t.pagamento] || 'üí≥'} ${t.pagamento} ‚Ä¢ ` : ''}
                                üìÖ ${new Date(t.data).toLocaleDateString('pt-BR')}
                                ${t.observacao ? `<br>üìå ${t.observacao}` : ''}
                            </div>
                        </div>
                        <div class="transaction-actions">
                            <button class="action-btn edit" onclick="editarTransacao(${t.id})">‚úèÔ∏è</button>
                            <button class="action-btn delete" onclick="deletarTransacao(${t.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });

            listaDiv.innerHTML = html;
        }

        function filtrarLancamentos() {
            atualizarListaLancamentos();
        }

        function preencherFiltros() {
            const filtroMes = document.getElementById('filtroMes');
            const filtroConta = document.getElementById('filtroConta');
            
            if (filtroMes) {
                filtroMes.innerHTML = '<option value="all">Todos os meses</option>';
                const meses = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                meses.forEach((mes, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = mes;
                    filtroMes.appendChild(option);
                });
            }

            if (filtroConta) {
                filtroConta.innerHTML = '<option value="all">Todas as contas</option>';
                contas.forEach(conta => {
                    const option = document.createElement('option');
                    option.value = conta.id;
                    option.textContent = conta.nome;
                    filtroConta.appendChild(option);
                });
            }
        }

        // ============================================
        // FUN√á√ïES DE CONTAS
        // ============================================
        async function adicionarConta() {
            const nome = document.getElementById('nomeConta').value;
            const saldoInicialInput = document.getElementById('saldoInicial').value;
            const saldoInicial = converterMoedaParaNumber(saldoInicialInput) || 0;
            const tipo = document.getElementById('tipoConta').value;
            const cor = document.getElementById('corConta').value;

            if (!nome) {
                alert('Digite um nome para a conta!');
                return;
            }

            const novaConta = {
                id: Date.now(),
                nome: nome,
                tipo: tipo,
                saldoInicial: saldoInicial,
                cor: cor
            };

            contas.push(novaConta);
            await salvarDadosFirebase();
            salvarDadosLocal();

            document.getElementById('nomeConta').value = '';
            document.getElementById('saldoInicial').value = '0,00';
            
            atualizarListaContas();
            preencherSelectContas();
            preencherFiltros();
        }

        function atualizarListaContas() {
            const listaDiv = document.getElementById('listaContas');
            if (!listaDiv) return;

            if (contas.length === 0) {
                listaDiv.innerHTML = '<div class="empty-state">üè¶ Nenhuma conta cadastrada</div>';
                return;
            }

            let html = '';
            contas.forEach(conta => {
                const saldo = calcularSaldoConta(conta.id) + (conta.saldoInicial || 0);
                
                html += `
                    <div class="conta-card" style="border-left: 4px solid ${conta.cor}">
                        <span class="conta-tipo">${conta.tipo}</span>
                        <div class="conta-nome">${conta.nome}</div>
                        <div class="conta-saldo">R$ ${saldo.toFixed(2).replace('.', ',')}</div>
                        <div class="conta-actions">
                            <button class="action-btn delete" onclick="deletarConta(${conta.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });

            listaDiv.innerHTML = html;
        }

        function calcularSaldoConta(contaId) {
            return transacoes
                .filter(t => t.contaId === contaId)
                .reduce((total, t) => {
                    return total + (t.tipo === 'receita' ? t.valor : -t.valor);
                }, 0);
        }

        function deletarConta(id) {
            if (confirm('Tem certeza? Todas as transa√ß√µes desta conta tamb√©m ser√£o removidas!')) {
                transacoes = transacoes.filter(t => t.contaId !== id);
                contas = contas.filter(c => c.id !== id);
                salvarDados();
                atualizarListaContas();
                preencherSelectContas();
                preencherFiltros();
                atualizarDashboard();
            }
        }

        // ============================================
        // FUN√á√ïES DE OR√áAMENTO
        // ============================================
        function preencherCategoriasPrevisao() {
            const select = document.getElementById('categoriaPrevista');
            if (!select) return;
            
            select.innerHTML = '';
            categorias[tipoPrevisao].forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }

        async function adicionarPrevisao() {
            const mes = document.getElementById('mesOrcamento').value;
            const valorInput = document.getElementById('valorPrevisto').value;
            const valor = converterMoedaParaNumber(valorInput);
            const descricao = document.getElementById('descricaoPrevista').value;
            const categoria = document.getElementById('categoriaPrevista').value;
            const dia = document.getElementById('diaVencimento').value;

            if (!mes) {
                alert('Selecione o m√™s!');
                return;
            }

            if (!valor || valor <= 0) {
                alert('Digite um valor v√°lido!');
                return;
            }

            if (!descricao) {
                alert('Digite uma descri√ß√£o!');
                return;
            }

            const novaPrevisao = {
                id: Date.now(),
                mes: mes,
                tipo: tipoPrevisao,
                valor: valor,
                descricao: descricao,
                categoria: categoria,
                dia: dia || 1
            };

            previsoes.push(novaPrevisao);
            await salvarDadosFirebase();
            salvarDadosLocal();

            document.getElementById('valorPrevisto').value = '';
            document.getElementById('descricaoPrevista').value = '';
            document.getElementById('diaVencimento').value = '';

            carregarOrcamento();
        }

        function carregarOrcamento() {
            const mes = document.getElementById('mesOrcamento').value;
            if (!mes) return;

            const previsoesMes = previsoes.filter(p => p.mes === mes);

            let totalReceitas = 0;
            let totalDespesas = 0;

            previsoesMes.forEach(p => {
                if (p.tipo === 'receita') totalReceitas += p.valor;
                else totalDespesas += p.valor;
            });

            document.getElementById('totalReceitasPrevistas').textContent = `R$ ${totalReceitas.toFixed(2).replace('.', ',')}`;
            document.getElementById('totalDespesasPrevistas').textContent = `R$ ${totalDespesas.toFixed(2).replace('.', ',')}`;
            document.getElementById('saldoPrevisto').textContent = `R$ ${(totalReceitas - totalDespesas).toFixed(2).replace('.', ',')}`;

            const listaDiv = document.getElementById('listaPrevisoes');
            if (!listaDiv) return;

            if (previsoesMes.length === 0) {
                listaDiv.innerHTML = '<div class="empty-state">üìÖ Nenhuma previs√£o para este m√™s</div>';
                return;
            }

            let html = '';
            previsoesMes.sort((a, b) => a.dia - b.dia).forEach(p => {
                html += `
                    <div class="orcamento-item">
                        <div class="orcamento-header-item">
                            <span style="color: ${p.tipo === 'receita' ? 'var(--income)' : 'var(--expense)'}">
                                ${p.tipo === 'receita' ? 'üìà' : 'üìâ'} R$ ${p.valor.toFixed(2).replace('.', ',')}
                            </span>
                            <span>Dia ${p.dia}</span>
                        </div>
                        <div><strong>${p.descricao}</strong></div>
                        <div style="font-size: 12px; color: var(--text-secondary)">${p.categoria}</div>
                        <div style="margin-top: 10px;">
                            <button class="action-btn delete" onclick="deletarPrevisao(${p.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });

            listaDiv.innerHTML = html;
        }

        function deletarPrevisao(id) {
            if (confirm('Remover esta previs√£o?')) {
                previsoes = previsoes.filter(p => p.id !== id);
                salvarDados();
                carregarOrcamento();
            }
        }

        // ============================================
        // FUN√á√ïES DE RELAT√ìRIOS
        // ============================================
        function preencherSelectMeses() {
            const selectMes = document.getElementById('relatorioMes');
            const selectAno = document.getElementById('relatorioAno');
            
            if (selectMes) {
                selectMes.innerHTML = '<option value="all">Todos os meses</option>';
                const meses = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                meses.forEach((mes, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = mes;
                    selectMes.appendChild(option);
                });
            }
        }

        function gerarRelatorio() {
            const mes = document.getElementById('relatorioMes').value;
            const ano = parseInt(document.getElementById('relatorioAno').value);

            let transacoesFiltradas = transacoes.filter(t => {
                const data = new Date(t.data);
                return data.getFullYear() === ano && (mes === 'all' || data.getMonth() === parseInt(mes));
            });

            let totalReceitas = 0;
            let totalDespesas = 0;
            let porCategoria = {};

            transacoesFiltradas.forEach(t => {
                if (t.tipo === 'receita') {
                    totalReceitas += t.valor;
                } else {
                    totalDespesas += t.valor;
                }

                if (!porCategoria[t.categoria]) {
                    porCategoria[t.categoria] = { receitas: 0, despesas: 0 };
                }
                
                if (t.tipo === 'receita') {
                    porCategoria[t.categoria].receitas += t.valor;
                } else {
                    porCategoria[t.categoria].despesas += t.valor;
                }
            });

            const resumoDiv = document.getElementById('relatorioResumo');
            if (resumoDiv) {
                resumoDiv.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-title">üìà Total Receitas</div>
                        <div class="stat-value" style="color: var(--income)">R$ ${totalReceitas.toFixed(2).replace('.', ',')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">üìâ Total Despesas</div>
                        <div class="stat-value" style="color: var(--expense)">R$ ${totalDespesas.toFixed(2).replace('.', ',')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">üí∞ Saldo do Per√≠odo</div>
                        <div class="stat-value" style="color: ${totalReceitas - totalDespesas >= 0 ? 'var(--income)' : 'var(--expense)'}">
                            R$ ${(totalReceitas - totalDespesas).toFixed(2).replace('.', ',')}
                        </div>
                    </div>
                `;
            }

            const tbody = document.getElementById('corpoTabelaCategorias');
            if (tbody) {
                let html = '';
                for (let cat in porCategoria) {
                    const saldo = porCategoria[cat].receitas - porCategoria[cat].despesas;
                    html += `
                        <tr>
                            <td>${cat}</td>
                            <td style="color: var(--income)">R$ ${porCategoria[cat].receitas.toFixed(2).replace('.', ',')}</td>
                            <td style="color: var(--expense)">R$ ${porCategoria[cat].despesas.toFixed(2).replace('.', ',')}</td>
                            <td style="color: ${saldo >= 0 ? 'var(--income)' : 'var(--expense)'}">
                                R$ ${saldo.toFixed(2).replace('.', ',')}
                            </td>
                        </tr>
                    `;
                }
                tbody.innerHTML = html;
            }
        }

        // ============================================
        // FUN√á√ïES DE DASHBOARD
        // ============================================
        function atualizarDashboard() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            let totalReceitas = 0;
            let totalDespesas = 0;
            let receitasMes = 0;
            let despesasMes = 0;

            transacoes.forEach(t => {
                const data = new Date(t.data);
                
                if (t.tipo === 'receita') {
                    totalReceitas += t.valor;
                    if (data.getMonth() === mesAtual && data.getFullYear() === anoAtual) {
                        receitasMes += t.valor;
                    }
                } else {
                    totalDespesas += t.valor;
                    if (data.getMonth() === mesAtual && data.getFullYear() === anoAtual) {
                        despesasMes += t.valor;
                    }
                }
            });

            document.getElementById('saldoTotal').textContent = `R$ ${(totalReceitas - totalDespesas).toFixed(2).replace('.', ',')}`;
            document.getElementById('totalReceitas').textContent = `üìà Receitas: R$ ${totalReceitas.toFixed(2).replace('.', ',')}`;
            document.getElementById('totalDespesas').textContent = `üìâ Despesas: R$ ${totalDespesas.toFixed(2).replace('.', ',')}`;
            
            document.getElementById('pagamentosMes').textContent = `R$ ${despesasMes.toFixed(2).replace('.', ',')}`;
            document.getElementById('recebimentosMes').textContent = `R$ ${receitasMes.toFixed(2).replace('.', ',')}`;

            let saldoContas = 0;
            contas.forEach(conta => {
                saldoContas += calcularSaldoConta(conta.id) + (conta.saldoInicial || 0);
            });
            
            document.getElementById('saldoContas').textContent = `R$ ${saldoContas.toFixed(2).replace('.', ',')}`;
            document.getElementById('totalContas').textContent = `${contas.length} contas ativas`;

            const mesKey = `${anoAtual}-${String(mesAtual + 1).padStart(2, '0')}`;
            const previsoesMes = previsoes.filter(p => p.mes === mesKey);
            
            let receitasPrevistas = 0;
            let despesasPrevistas = 0;
            
            previsoesMes.forEach(p => {
                if (p.tipo === 'receita') receitasPrevistas += p.valor;
                else despesasPrevistas += p.valor;
            });

            document.getElementById('pagamentosPrevistos').textContent = `Previsto: R$ ${despesasPrevistas.toFixed(2).replace('.', ',')}`;
            document.getElementById('recebimentosPrevistos').textContent = `Previsto: R$ ${receitasPrevistas.toFixed(2).replace('.', ',')}`;
            document.getElementById('totalPrevisto').textContent = `üìÖ Previsto: R$ ${(receitasPrevistas - despesasPrevistas).toFixed(2).replace('.', ',')}`;
        }

        // ============================================
        // FUN√á√ïES DE MODO ESCURO
        // ============================================
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const btn = document.querySelector('.dark-mode-toggle');
            
            if (document.body.classList.contains('dark-mode')) {
                btn.textContent = '‚òÄÔ∏è Modo Claro';
                localStorage.setItem('darkMode', 'true');
            } else {
                btn.textContent = 'üåô Modo Escuro';
                localStorage.setItem('darkMode', 'false');
            }
        }

        function carregarModoEscuro() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'true') {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-mode-toggle').textContent = '‚òÄÔ∏è Modo Claro';
            }
        }

        function atualizarTela() {
            atualizarDashboard();
            if (document.getElementById('lancamentos').classList.contains('active')) {
                preencherCategorias();
                preencherSelectContas();
                preencherFiltros();
                atualizarListaLancamentos();
            }
            if (document.getElementById('contas').classList.contains('active')) {
                atualizarListaContas();
            }
            if (document.getElementById('orcamento').classList.contains('active')) {
                carregarOrcamento();
            }
        }

        // ============================================
        // SERVICE WORKER
        // ============================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js');
            });
        }

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        
        // Adicionar eventos de formata√ß√£o nos campos de valor
        document.addEventListener('DOMContentLoaded', function() {
            const camposValor = ['valor', 'saldoInicial', 'valorPrevisto'];
            
            camposValor.forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.addEventListener('input', function() {
                        formatarMoeda(this);
                    });
                    
                    campo.addEventListener('blur', function() {
                        if (this.value === '') {
                            this.value = '0,00';
                        } else {
                            // Garantir formato correto ao sair do campo
                            formatarMoeda(this);
                        }
                    });
                }
            });
        });

        carregarDados();
        carregarModoEscuro();
        
        const hoje = new Date().toISOString().split('T')[0];
        if (document.getElementById('dataLancamento')) {
            document.getElementById('dataLancamento').value = hoje;
        }

        const mesAtual = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
        if (document.getElementById('mesOrcamento')) {
            document.getElementById('mesOrcamento').value = mesAtual;
        }
    </script>
</body>
</html>
