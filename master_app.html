<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëë MASTER APP - CONTROLE TOTAL</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* (mesmo estilo que j√° tens - mant√©m) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #1a1a2e;
            --bg-card: #2a2a40;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #4CAF50;
            --warning: #ff9800;
            --danger: #f44336;
            --info: #2196F3;
            --gold: gold;
            --neon: #00ffaa;
        }

        body {
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* HEADER FUTURISTA */
        .header {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 255, 170, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 170, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: clamp(24px, 4vw, 32px);
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px var(--neon);
        }

        .status {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .power-btn {
            background: linear-gradient(45deg, var(--accent), var(--neon));
            color: black;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .power-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--neon);
        }

        /* GRID PRINCIPAL */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        /* PAINEL DE CLIENTES */
        .clientes-panel {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            border-left: 4px solid var(--neon);
        }

        .cliente-item {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .cliente-item:hover {
            border-color: var(--neon);
            transform: translateX(5px);
            box-shadow: 0 0 15px rgba(0, 255, 170, 0.3);
        }

        .cliente-item.active {
            border-color: var(--neon);
            background: #33334d;
        }

        .cliente-actions {
            display: flex;
            gap: 5px;
        }

        .action-icon {
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-icon:hover {
            background: var(--neon);
            color: black;
        }

        /* PAINEL DE EDI√á√ÉO FUTURISTA */
        .editor-panel {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            border-top: 4px solid var(--neon);
        }

        .editor-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #404040;
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab:hover {
            background: var(--bg-secondary);
            color: white;
        }

        .tab.active {
            background: var(--neon);
            color: black;
        }

        /* VISUALIZADOR DO SITE */
        .site-preview {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            min-height: 300px;
            color: black;
            border: 2px solid var(--neon);
            box-shadow: 0 0 30px rgba(0, 255, 170, 0.3);
        }

        /* EDITOR DE C√ìDIGO */
        .code-editor {
            background: #1e1e1e;
            border-radius: 15px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            color: #00ff00;
            border: 1px solid #404040;
        }

        .code-editor textarea {
            width: 100%;
            height: 300px;
            background: #1e1e1e;
            color: #00ff00;
            border: none;
            font-family: 'Courier New', monospace;
            padding: 10px;
            resize: vertical;
        }

        /* BOT√ïES DE CONTROLE */
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .control-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit { background: var(--info); color: white; }
        .btn-block { background: var(--danger); color: white; }
        .btn-save { background: var(--accent); color: white; }
        .btn-view { background: var(--gold); color: black; }

        .control-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        /* LOG */
        .log-panel {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 10px;
            margin-top: 20px;
            max-height: 100px;
            overflow-y: auto;
            font-size: 12px;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border-left: 5px solid var(--neon);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--neon);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER FUTURISTA -->
        <div class="header">
            <div>
                <h1>üëë MASTER APP - CONTROLE TOTAL</h1>
                <p style="color: var(--neon);">‚ö° Editando TUDO dos clientes</p>
            </div>
            <div class="status">
                <span id="firebaseStatus" style="color: var(--neon);">üîµ Conectando...</span>
                <span id="clientesCount">üìä 0 clientes</span>
                <button class="power-btn" onclick="mostrarAjuda()">üöÄ PODERES</button>
                <button class="power-btn" onclick="diagnosticarConexao()">üîç DIAGN√ìSTICO</button>
            </div>
        </div>

        <!-- GRID PRINCIPAL -->
        <div class="main-grid">
            <!-- PAINEL CLIENTES -->
            <div class="clientes-panel">
                <h2 style="margin-bottom: 20px; color: var(--neon);">üìã CLIENTES</h2>
                
                <div style="margin-bottom: 15px;">
                    <input type="text" id="buscarCliente" placeholder="üîç Buscar cliente..." onkeyup="filtrarClientes()" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid #404040; border-radius: 8px; color: white;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <button onclick="criarCliente()" style="width: 100%; padding: 10px; background: var(--accent); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
                        ‚ûï NOVO CLIENTE
                    </button>
                </div>
                
                <div id="listaClientes">
                    <!-- Clientes ser√£o carregados aqui -->
                    <div class="loading">üì° Carregando clientes...</div>
                </div>
            </div>

            <!-- PAINEL EDI√á√ÉO -->
            <div class="editor-panel" id="editorPanel">
                <div class="editor-tabs">
                    <button id="tab-visual" class="tab-btn active" onclick="mudarAba('visual', this)">Visual</button>
                    <button id="tab-conteudo" class="tab-btn" onclick="mudarAba('conteudo', this)">Conte√∫do</button>
                    <button id="tab-funcoes" class="tab-btn" onclick="mudarAba('funcoes', this)">Fun√ß√µes</button>
                    <button id="tab-codigo" class="tab-btn" onclick="mudarAba('codigo', this)">C√≥digo</button>
                </div>

                <!-- ABA VISUAL -->
                <div id="abaVisual" class="tab-content active">
                    <h3 style="margin-bottom: 15px;">üé® EDITOR VISUAL</h3>
                    
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label>üè¢ NOME DA EMPRESA</label>
                            <input type="text" id="nomeEmpresa" value="" onchange="alteracaoNaoSalva()" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid #404040; border-radius: 8px; color: white;">
                        </div>
                        <div>
                            <label>üë§ PERFIL</label>
                            <select id="perfilCliente" onchange="alteracaoNaoSalva()" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid #444; border-radius: 8px; color: var(--text-primary);">
                                <option value="pf">PESSOAL/FAMILIAR</option>
                                <option value="pj">EMPRESARIAL</option>
                            </select>
                            <small style="color: var(--text-secondary); display:block; margin-top:6px;">
                                PF: controle pessoal/familiar. PJ: empresa/neg√≥cio.
                            </small>
                        </div>

                        <div>
                            <label>üßæ CPF ou CNPJ (opcional)</label>
                            <input type="text" id="cpfCnpj" placeholder="Ex.: 000.000.000-00 ou 00.000.000/0000-00" onchange="alteracaoNaoSalva()" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid #444; border-radius: 8px; color: var(--text-primary);">
                        </div>

                        <div>
                            <label>üÜî ID do cliente (gerado pelo sistema)</label>
                            <input type="text" id="clienteIdVisivel" disabled style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid #444; border-radius: 8px; color: var(--text-primary); opacity: .85; cursor: not-allowed;">
                            <small style="color: var(--text-secondary); display:block; margin-top:6px;">
                                Esse ID √© o que voc√™ envia no link do Financeiro (ex.: ?cliente=ID).
                            </small>
                        </div>

                        
                        <div>
                            <label>üé® COR PRINCIPAL</label>
                            <input type="color" id="corPrincipal" value="#4CAF50" onchange="alteracaoNaoSalva()" style="width: 100%; height: 50px;">
                        </div>
                        
                        <div>
                            <label>üåô MODO ESCURO</label>
                            <select id="modoEscuro" onchange="alteracaoNaoSalva()" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid #404040; border-radius: 8px; color: white;">
                                <option value="auto">Autom√°tico (padr√£o)</option>
                                <option value="light">Sempre claro</option>
                                <option value="dark">Sempre escuro</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ABA CONTE√öDO -->
                <div id="abaConteudo" class="tab-content">
                    <h3 style="margin-bottom: 15px;">üìù EDITOR DE CONTE√öDO</h3>
                    
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label>üë§ Termo para colaborador</label>
                            <input type="text" id="termoColaborador" value="Motorista" onchange="alteracaoNaoSalva()" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid #404040; border-radius: 8px; color: white;">
                        </div>
                        
                        <div>
                            <label>üì¶ Termo para a√ß√£o</label>
                            <input type="text" id="termoAcao" value="Entrega" onchange="alteracaoNaoSalva()" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid #404040; border-radius: 8px; color: white;">
                        </div>
                        
                        <div>
                            <label>üë• Termo para cliente</label>
                            <input type="text" id="termoCliente" value="Cliente" onchange="alteracaoNaoSalva()" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid #404040; border-radius: 8px; color: white;">
                        </div>
                        
                        <div>
                            <label>üí∞ Moeda</label>
                            <select id="moeda" onchange="alteracaoNaoSalva()" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid #404040; border-radius: 8px; color: white;">
                                <option value="BRL">Real (R$)</option>
                                <option value="USD">D√≥lar ($)</option>
                                <option value="EUR">Euro (‚Ç¨)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ABA FUN√á√ïES -->
                <div id="abaFuncoes" class="tab-content">
                    <h3 style="margin-bottom: 15px;">‚öôÔ∏è CONTROLE DE FUN√á√ïES</h3>
                    <p style="color: var(--warning); font-size: 12px; margin-bottom: 15px;">üîí Desative fun√ß√µes para limitar o acesso do cliente</p>
                    
                    <div style="display: grid; gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="funcDashboard" checked onchange="alteracaoNaoSalva()"> üìä Dashboard
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="funcLancamentos" checked onchange="alteracaoNaoSalva()"> üìù Lan√ßamentos
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="funcContas" checked onchange="alteracaoNaoSalva()"> üè¶ Contas
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="funcOrcamento" checked onchange="alteracaoNaoSalva()"> üìÖ Or√ßamento
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="funcRelatorios" checked onchange="alteracaoNaoSalva()"> üìà Relat√≥rios
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="funcPlanos" onchange="alteracaoNaoSalva()"> üí∞ Planos (assinaturas)
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="funcImportar" checked onchange="alteracaoNaoSalva()"> üì• Importa√ß√£o/Exporta√ß√£o
                        </label>
                    </div>
                </div>

                <!-- ABA C√ìDIGO -->
                <div id="abaCodigo" class="tab-content">
                    <h3 style="margin-bottom: 15px;">üíª EDITOR DE C√ìDIGO</h3>
                    <p style="color: var(--warning); font-size: 12px; margin-bottom: 15px;">‚ö° Edite o HTML diretamente (apenas para avan√ßados)</p>
                    
                    <div class="code-editor">
                        <textarea id="codigoHtml" placeholder="&lt;!-- C√≥digo HTML personalizado --&gt;" onchange="alteracaoNaoSalva()">
</textarea>
                        <div class="invite-box" style="margin-top:12px; padding:12px; border:1px dashed rgba(255,255,255,0.25); border-radius:10px;">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                                <div>
                                    <div style="font-weight:700;">üîó Convite de cadastro do cliente</div>
                                    <div style="font-size:12px; opacity:0.9; margin-top:4px;">
                                        Gera um link √∫nico para o cliente preencher os dados. (O cadastro por convite ser√° ativado no Financeiro quando voc√™ decidir.)
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <button class="control-btn btn-view" onclick="gerarConviteCadastro()" id="btnGerarConvite" disabled>‚ú® GERAR CONVITE</button>
                                    <button class="control-btn btn-view" onclick="copiarUltimoConvite()" id="btnCopiarConvite" disabled>üìã COPIAR LINK</button>
                                </div>
                            </div>
                            <input id="ultimoConviteLink" readonly style="margin-top:10px; width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color:#fff;" placeholder="O link do convite vai aparecer aqui..." />
                        </div>

                    </div>
                </div>

                <!-- VISUALIZA√á√ÉO DO SITE (Preview) -->
                <div class="site-preview" id="sitePreview">
                    <div id="previewConteudo" style="text-align: center;">
                        <div id="previewLogoBox" style="width: 120px; height: 120px; background: #ddd; margin: 0 auto; border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
  <span id="previewLogoPlaceholder" style="color:#555;font-weight:600;">LOGO</span>
  <img id="previewLogoImg" alt="Logo do cliente" style="display:none; width:100%; height:100%; object-fit:contain; background:transparent;" />
</div>
                        <h2 id="previewTitulo" style="margin: 10px 0;">Selecione um cliente</h2>
                        <div id="previewBotoes" style="display: flex; gap: 10px; justify-content: center;">
                            <span>üìä Dashboard</span>
                            <span>üìù Lan√ßamentos</span>
                            <span>üè¶ Contas</span>
                        </div>
                    </div>
                </div>

                <!-- BOT√ïES DE CONTROLE -->
                
                <!-- LOGOTIPO DO CLIENTE -->
                <div id="logoSection" style="margin-top: 16px; padding: 14px; border-radius: 14px; border: 1px dashed rgba(255,255,255,0.25);">
                    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                        <div>
                            <div style="font-weight:800;">üñºÔ∏è Logotipo do cliente</div>
                            <div style="font-size:12px; opacity:0.9; margin-top:4px;">
                                Espa√ßo ‚Äúm√©dio/grande‚Äù. O sistema comprime automaticamente para n√£o pesar no banco.
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="control-btn btn-edit" onclick="abrirSeletorLogo()" id="btnEscolherLogo" disabled>üì§ ENVIAR LOGO</button>
                            <button class="control-btn btn-block" onclick="removerLogoCliente()" id="btnRemoverLogo" disabled>üóëÔ∏è REMOVER</button>
                        </div>
                    </div>

                    <input type="file" id="logoInput" accept="image/*" style="display:none" />

                    <div id="logoDropArea" style="margin-top:12px; height: 180px; border-radius: 14px; background: rgba(0,0,0,0.20); display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;">
                        <div id="logoDropPlaceholder" style="text-align:center; padding:16px; opacity:0.95;">
                            <div style="font-size:40px;">üè∑Ô∏è</div>
                            <div style="margin-top:8px; font-weight:700;">Nenhum logo selecionado</div>
                            <div style="margin-top:6px; font-size:12px; opacity:0.9;">Clique em ‚ÄúENVIAR LOGO‚Äù (ou arraste uma imagem aqui)</div>
                        </div>
                        <img id="logoPreview" alt="Preview do logo" style="display:none; width:100%; height:100%; object-fit:contain; background:transparent;" />
                    </div>
                </div>


                <div class="control-buttons">
                    <button class="control-btn btn-edit" onclick="entrarModoEdicao()" id="btnEditar" disabled>
                        ‚úèÔ∏è EDITAR
                    </button>
                    <button class="control-btn btn-block" onclick="bloquearCliente()" id="btnBloquear" disabled>
                        üîí BLOQUEAR
                    </button>
                    <button class="control-btn btn-save" onclick="salvarAlteracoes()" id="btnSalvar" disabled>
                        üíæ SALVAR
                    </button>
                    <button class="control-btn btn-view" onclick="verComoCliente()" id="btnVisualizar" disabled>
                        üëÅÔ∏è VER COMO CLIENTE
                    </button>
                    <button class="control-btn btn-view" onclick="copiarLinkClienteAtual()" id="btnCopiarLink" disabled>
                        üîó COPIAR LINK
                    </button>
                </div>

                <!-- LOG -->
                <div class="log-panel" id="logPanel">
                    <div>üöÄ Sistema pronto para controle total</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div id="modalConfirm" class="modal">
        <div class="modal-content">
            <h2 id="modalTitulo">‚ö° Confirma√ß√£o</h2>
            <p id="modalMsg">Tem certeza?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button style="flex:1; padding: 10px; background: var(--accent);" onclick="confirmarAcao()">SIM</button>
                <button style="flex:1; padding: 10px; background: var(--danger);" onclick="fecharModal()">N√ÉO</button>
            </div>
        </div>
    </div>

    <!-- MODAL NOVO CLIENTE -->
    <div id="modalNovoCliente" class="modal">
        <div class="modal-content">
            <h2>‚ûï NOVO CLIENTE</h2>
            <div style="margin: 20px 0;">
                <label>Nome da Empresa:</label>
                <input type="text" id="novoClienteNome" style="width: 100%; padding: 10px; margin-top: 5px; background: var(--bg-secondary); border: 1px solid #404040; border-radius: 8px; color: white;">
            </div>
            <div style="margin: 20px 0;">
                <label>Plano:</label>
                <select id="novoClientePlano" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid #404040; border-radius: 8px; color: white;">
                    <option value="basico">B√°sico</option>
                    <option value="profissional">Profissional</option>
                    <option value="empresarial">Empresarial</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button style="flex:1; padding: 10px; background: var(--accent);" onclick="criarClienteFirebase()">CRIAR</button>
                <button style="flex:1; padding: 10px; background: var(--danger);" onclick="fecharModalNovoCliente()">CANCELAR</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO FIREBASE
        // ============================================
        const firebaseConfig = {
  apiKey: "AIzaSyArkRZLVVJNzx6I6GcWVF7NnjIkrF1jrcU",
  authDomain: "painelmastercomplet.firebaseapp.com",
  projectId: "painelmastercomplet",
  storageBucket: "painelmastercomplet.firebasestorage.app",
  messagingSenderId: "87580974705",
  appId: "1:87580974705:web:bd17f8609687f25ee4c5d0"
};

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ============================================
        // VARI√ÅVEIS GLOBAIS
        // ============================================
        let clientes = [];
        let clienteAtual = null;
        let acaoPendente = null;
        let alteracoesNaoSalvas = false;

        // ============================================
        // FUN√á√ïES PRINCIPAIS
        // ============================================
        
        // Carregar clientes do Firebase
        function carregarClientes() {
            document.getElementById('firebaseStatus').innerHTML = 'üîÑ Carregando...';
            
            db.collection('clientes').onSnapshot((snapshot) => {
                clientes = [];
                snapshot.forEach(doc => {
                    clientes.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                document.getElementById('clientesCount').innerHTML = `üìä ${clientes.length} clientes`;
                document.getElementById('firebaseStatus').innerHTML = 'üü¢ Conectado';
                
                atualizarListaClientes();
                
                // Se tinha um cliente selecionado, atualiza
                if (clienteAtual) {
                    const atualizado = clientes.find(c => c.id === clienteAtual.id);
                    if (atualizado) {
                        clienteAtual = atualizado;
                        preencherFormularioCliente();
                    }
                }
                
                adicionarLog('üì° Dados sincronizados com Firebase');
            }, (error) => {
                console.error('Erro ao carregar clientes:', error);
                document.getElementById('firebaseStatus').innerHTML = 'üî¥ Erro de conex√£o';
                document.getElementById('listaClientes').innerHTML = '<div style="color: var(--danger); padding: 20px;">‚ùå Erro ao carregar clientes</div>';
            });
        }

        // Atualizar lista de clientes na interface
        function atualizarListaClientes() {
            const lista = document.getElementById('listaClientes');
            const filtro = document.getElementById('buscarCliente')?.value.toLowerCase() || '';
            
            if (clientes.length === 0) {
                lista.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--text-secondary);">üì≠ Nenhum cliente cadastrado</div>';
                return;
            }
            
            let html = '';
            const clientesFiltrados = clientes.filter(c => c.nome?.toLowerCase().includes(filtro));
            
            clientesFiltrados.forEach(c => {
                const ativo = clienteAtual && clienteAtual.id === c.id;
                html += `
                    <div class="cliente-item ${ativo ? 'active' : ''}" onclick="selecionarCliente('${c.id}')">
                        <div>
                            <strong>${c.nome || 'Sem nome'}</strong>
                            <p style="font-size: 11px; color: ${c.status === 'ativo' ? '#4CAF50' : '#f44336'}">
                                ${c.status || 'ativo'} ‚Ä¢ ${c.plano || 'basico'}
                            </p>
                        </div>
                        <div class="cliente-actions">
                            <span class="action-icon" title="Editar" onclick="entrarModoEdicao(); event.stopPropagation()">‚úèÔ∏è</span>
                            <span class="action-icon" title="Bloquear" onclick="bloquearCliente(); event.stopPropagation()">üîí</span>
                            <span class="action-icon" title="Visualizar" onclick="verComoCliente(); event.stopPropagation()">üëÅÔ∏è</span>
                            <span class="action-icon" title="Excluir" style="color: #f44336;" onclick="deletarCliente('${c.id}', event)">üóëÔ∏è</span>
                        </div>
                    </div>
                `;
            });
            
            lista.innerHTML = html || '<div style="padding: 20px; color: var(--text-secondary);">üîç Nenhum cliente encontrado</div>';
        }

        // Selecionar cliente
        async function selecionarCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return;
            
            // Verificar se h√° altera√ß√µes n√£o salvas
            if (alteracoesNaoSalvas) {
                if (!confirm('‚ö†Ô∏è H√° altera√ß√µes n√£o salvas! Deseja realmente mudar de cliente?')) {
                    return;
                }
            }
            
            clienteAtual = cliente;
            alteracoesNaoSalvas = false;
            
            // Atualizar UI
            atualizarListaClientes();
            preencherFormularioCliente();
            
            // Habilitar bot√µes
            document.getElementById('btnEditar').disabled = false;
            document.getElementById('btnBloquear').disabled = false;
            document.getElementById('btnSalvar').disabled = false;
            document.getElementById('btnVisualizar').disabled = false;
            document.getElementById('btnCopiarLink').disabled = false;
            document.getElementById('btnEscolherLogo').disabled = false;
            document.getElementById('btnRemoverLogo').disabled = false;
            document.getElementById('btnGerarConvite').disabled = false;
            
            adicionarLog(`üìÇ Cliente selecionado: ${cliente.nome}`);
        }

        // Preencher formul√°rio com dados do cliente
        function preencherFormularioCliente() {
            if (!clienteAtual) return;
            
            // Dados b√°sicos
            document.getElementById('nomeEmpresa').value = clienteAtual.nome || '';
            document.getElementById('corPrincipal').value = clienteAtual.cor || '#4CAF50';
            document.getElementById('modoEscuro').value = clienteAtual.modoEscuro || 'auto';
            
            // Termos
            document.getElementById('termoColaborador').value = clienteAtual.termoColaborador || 'Motorista';
            document.getElementById('termoAcao').value = clienteAtual.termoAcao || 'Entrega';
            document.getElementById('termoCliente').value = clienteAtual.termoCliente || 'Cliente';
            document.getElementById('moeda').value = clienteAtual.moeda || 'BRL';
            
            // Fun√ß√µes
            document.getElementById('funcDashboard').checked = clienteAtual.funcDashboard !== false;
            document.getElementById('funcLancamentos').checked = clienteAtual.funcLancamentos !== false;
            document.getElementById('funcContas').checked = clienteAtual.funcContas !== false;
            document.getElementById('funcOrcamento').checked = clienteAtual.funcOrcamento !== false;
            document.getElementById('funcRelatorios').checked = clienteAtual.funcRelatorios !== false;
            document.getElementById('funcPlanos').checked = clienteAtual.funcPlanos === true;
            document.getElementById('funcImportar').checked = clienteAtual.funcImportar !== false;
            
            // C√≥digo HTML personalizado
            document.getElementById('codigoHtml').value = clienteAtual.codigoHtml || '';
            
            // Logo
            logoTempBase64 = null;
            setLogoPreview(clienteAtual.logoBase64 || null);

            // Atualizar preview
            atualizarPreview();
        }

        // Atualizar preview
        function atualizarPreview() {
            if (!clienteAtual) return;
            
            document.getElementById('previewTitulo').innerHTML = clienteAtual.nome || 'Empresa';
            // Logo no preview
            setLogoPreview(logoTempBase64 || clienteAtual.logoBase64 || null);
            
            let botoes = [];
            if (document.getElementById('funcDashboard').checked) botoes.push('üìä Dashboard');
            if (document.getElementById('funcLancamentos').checked) botoes.push('üìù Lan√ßamentos');
            if (document.getElementById('funcContas').checked) botoes.push('üè¶ Contas');
            
            document.getElementById('previewBotoes').innerHTML = botoes.map(b => `<span>${b}</span>`).join('');
        }

        // Marcar que houve altera√ß√£o
        function alteracaoNaoSalva() {
            alteracoesNaoSalvas = true;
            atualizarPreview();
        }

        // Salvar altera√ß√µes no Firebase
        async function salvarAlteracoes() {
            if (!clienteAtual) {
                alert('Selecione um cliente primeiro!');
                return;
            }
            
            const dadosAtualizados = {
                nome: document.getElementById('nomeEmpresa').value,
                perfil: (document.getElementById('perfilCliente') ? document.getElementById('perfilCliente').value : 'pj'),
                cpfCnpj: (document.getElementById('cpfCnpj') ? document.getElementById('cpfCnpj').value : ''),
                cor: document.getElementById('corPrincipal').value,
                modoEscuro: document.getElementById('modoEscuro').value,
                termoColaborador: document.getElementById('termoColaborador').value,
                termoAcao: document.getElementById('termoAcao').value,
                termoCliente: document.getElementById('termoCliente').value,
                moeda: document.getElementById('moeda').value,
                funcDashboard: document.getElementById('funcDashboard').checked,
                funcLancamentos: document.getElementById('funcLancamentos').checked,
                funcContas: document.getElementById('funcContas').checked,
                funcOrcamento: document.getElementById('funcOrcamento').checked,
                funcRelatorios: document.getElementById('funcRelatorios').checked,
                funcPlanos: document.getElementById('funcPlanos').checked,
                funcImportar: document.getElementById('funcImportar').checked,
                codigoHtml: document.getElementById('codigoHtml').value,
                logoBase64: (logoTempBase64 !== null ? (logoTempBase64 || '') : (clienteAtual.logoBase64 || '')),
                ultimaAlteracao: new Date().toISOString()
            };
            
            try {
                await db.collection('clientes').doc(clienteAtual.id).update(dadosAtualizados);
                // atualizar cache local
                clienteAtual.logoBase64 = dadosAtualizados.logoBase64 || '';
                logoTempBase64 = null;
                alteracoesNaoSalvas = false;
                adicionarLog(`üíæ Altera√ß√µes salvas para ${clienteAtual.nome}`);
                alert('‚úÖ Altera√ß√µes salvas com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('‚ùå Erro ao salvar altera√ß√µes');
            }
        }

        // Bloquear/desbloquear cliente
        async function bloquearCliente() {
            if (!clienteAtual) return;
            
            const novoStatus = clienteAtual.status === 'ativo' ? 'bloqueado' : 'ativo';
            
            document.getElementById('modalTitulo').textContent = novoStatus === 'bloqueado' ? 'üîí BLOQUEAR' : 'üîì DESBLOQUEAR';
            document.getElementById('modalMsg').textContent = `${novoStatus === 'bloqueado' ? 'Bloquear' : 'Desbloquear'} acesso de ${clienteAtual.nome}?`;
            document.getElementById('modalConfirm').style.display = 'flex';
            
            acaoPendente = 'bloquear';
        }

        // Ver como cliente
        
        function gerarLinkClientePorId(clienteId) {
            // Gera link absoluto para funcionar quando voc√™ copia/manda no WhatsApp
            // Ex.: https://usuario.github.io/repo/appfinanceiro.html?cliente=<ID>
            const base = window.location.origin + window.location.pathname.replace(/master_app\.html$/i, '');
            return `${base}appfinanceiro.html?cliente=${encodeURIComponent(clienteId)}`;
        }

        async function copiarLinkClienteAtual() {
            if (!clienteAtual) {
                alert('‚ö†Ô∏è Selecione um cliente primeiro!');
                return;
            }
            const url = gerarLinkClientePorId(clienteAtual.id);

            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(url);
                    alert('‚úÖ Link do cliente copiado!\n\n' + url);
                } else {
                    // fallback para navegadores antigos / contexto n√£o seguro
                    prompt('Copie o link do cliente:', url);
                }
                adicionarLog(`üîó Link do cliente ${clienteAtual.nome} copiado`);
            } catch (e) {
                console.warn('N√£o foi poss√≠vel copiar automaticamente:', e);
                prompt('Copie o link do cliente:', url);
            }
        }

        function verComoCliente() {
            if (!clienteAtual) {
                alert('‚ö†Ô∏è Selecione um cliente primeiro!');
                return;
            }
    
            // Construir URL corretamente
            const url = gerarLinkClientePorId(clienteAtual.id);
    
            // Abrir em nova aba
            const novaJanela = window.open(url, '_blank');
    
            // Verificar se foi bloqueado pelo popup blocker
            if (!novaJanela) {
                alert('‚ö†Ô∏è Permita popups para este site ou clique no link:\n\n' + url);
            }
    
            adicionarLog(`üëÅÔ∏è Visualizando ${clienteAtual.nome} como cliente`);
        }
        
        // Entrar em modo edi√ß√£o
        function entrarModoEdicao() {
            console.log('entrarModoEdicao chamado');
    
            if (!clienteAtual) {
                alert('‚ö†Ô∏è Selecione um cliente primeiro!');
                return;
            }
    
            document.getElementById('modalTitulo').textContent = '‚úèÔ∏è MODO EDI√á√ÉO';
            document.getElementById('modalMsg').textContent = `Ativar modo edi√ß√£o para ${clienteAtual.nome}? O cliente ser√° bloqueado durante a edi√ß√£o.`;
            document.getElementById('modalConfirm').style.display = 'flex';
    
            acaoPendente = 'editar';
        }

        // Confirmar a√ß√£o do modal
        async function confirmarAcao() {
            console.log('confirmarAcao chamado', acaoPendente);
    
            if (acaoPendente === 'editar') {
                try {
                    await db.collection('clientes').doc(clienteAtual.id).update({
                        status: 'bloqueado',
                        modoEdicaoAtivo: true
                    });
                    adicionarLog(`‚úèÔ∏è Modo edi√ß√£o ativado para ${clienteAtual.nome}`);
                    alert(`‚úÖ Modo edi√ß√£o ativado! O cliente ${clienteAtual.nome} est√° bloqueado.`);
                } catch (error) {
                    console.error('Erro ao bloquear:', error);
                    alert('‚ùå Erro ao ativar modo edi√ß√£o: ' + error.message);
                }
            } else if (acaoPendente === 'bloquear') {
                const novoStatus = clienteAtual.status === 'ativo' ? 'bloqueado' : 'ativo';
                try {
                    await db.collection('clientes').doc(clienteAtual.id).update({
                        status: novoStatus
                    });
                    adicionarLog(`üîí Cliente ${clienteAtual.nome} ${novoStatus}`);
                    alert(`‚úÖ Cliente ${novoStatus === 'ativo' ? 'desbloqueado' : 'bloqueado'}!`);
                } catch (error) {
                    console.error('Erro ao alterar status:', error);
                    alert('‚ùå Erro ao alterar status: ' + error.message);
                }
            }
    
            fecharModal();
        }

        // Criar novo cliente
        function criarCliente() {
            document.getElementById('modalNovoCliente').style.display = 'flex';
        }

        async function criarClienteFirebase() {
            const nome = document.getElementById('novoClienteNome').value;
            const plano = document.getElementById('novoClientePlano').value;
            
            if (!nome) {
                alert('Digite o nome da empresa!');
                return;
            }
            
            const novoCliente = {
                nome: nome,
                perfil: 'pj',
                cpfCnpj: '',
                plano: plano,
                status: 'ativo',
                cor: '#4CAF50',
                modoEscuro: 'auto',
                termoColaborador: 'Motorista',
                termoAcao: 'Entrega',
                termoCliente: 'Cliente',
                moeda: 'BRL',
                funcDashboard: true,
                funcLancamentos: true,
                funcContas: true,
                funcOrcamento: true,
                funcRelatorios: true,
                funcPlanos: false,
                funcImportar: true,
                dataCriacao: new Date().toISOString()
            };
            
            try {
                const docRef = await db.collection('clientes').add(novoCliente);
                const novoId = docRef.id;

                // Atualiza "clienteAtual" para facilitar copiar link / visualizar
                clienteAtual = { id: novoId, ...novoCliente };

                const linkCliente = gerarLinkClientePorId(novoId);

                adicionarLog(`‚ûï Cliente ${nome} criado com ID: ${novoId}`);

                // Tenta copiar o link automaticamente (se n√£o der, mostra pra copiar)
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(linkCliente);
                    }
                } catch (_) {}

                alert(`‚úÖ Cliente criado!\n\nNome: ${nome}\nC√≥digo (ID): ${novoId}\n\nLink do cliente:\n${linkCliente}\n\n(Dica: o link j√° foi copiado, se o navegador permitir.)`);

                // Recarrega lista e seleciona o novo cliente
                await carregarClientes();

                fecharModalNovoCliente();
                document.getElementById('novoClienteNome').value = '';
            } catch (error) {
                console.error('Erro ao criar cliente:', error);
                alert('‚ùå Erro ao criar cliente');
            }
        }

        // Fun√ß√µes auxiliares
        function mudarAba(aba, btnEl) {
  try {
    // Esconder todas as abas de conte√∫do
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');

    // Mostrar a aba selecionada
    const idMap = {
      visual: 'abaVisual',
      conteudo: 'abaConteudo',
      funcoes: 'abaFuncoes',
      codigo: 'abaCodigo'
    };
    const alvo = document.getElementById(idMap[aba] || 'abaVisual');
    if (alvo) alvo.style.display = 'block';

    // Marcar bot√£o ativo (sem depender de "event")
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (btnEl && btnEl.classList) btnEl.classList.add('active');
  } catch (e) {
    console.error('Erro ao mudar aba:', e);
  }
}

// Garantir que a primeira aba aparece ao abrir
document.addEventListener('DOMContentLoaded', () => {
  const firstBtn = document.getElementById('tab-visual');
  if (firstBtn) mudarAba('visual', firstBtn);
});


        function adicionarLog(msg) {
            const log = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.textContent = `‚è±Ô∏è ${new Date().toLocaleTimeString()} - ${msg}`;
            log.insertBefore(entry, log.firstChild);
            
            // Limitar logs
            if (log.children.length > 10) {
                log.removeChild(log.lastChild);
            }
        }

        function filtrarClientes() {
            atualizarListaClientes();
        }

        function mostrarAjuda() {
            alert(`üöÄ PODERES DO MASTER:\n\n` +
                  `‚úèÔ∏è Editar - Muda o sistema do cliente\n` +
                  `üîí Bloquear - Cliente perde acesso\n` +
                  `üíæ Salvar - Publica altera√ß√µes\n` +
                  `üëÅÔ∏è Visualizar - V√™ como cliente\n` +
                  `üé® Cores - Muda identidade visual\n` +
                  `üìù Textos - Personaliza termos\n` +
                  `‚öôÔ∏è Fun√ß√µes - Ativa/desativa m√≥dulos\n` +
                  `üíª C√≥digo - Edita HTML direto`);
        }

        function fecharModal() {
            document.getElementById('modalConfirm').style.display = 'none';
            acaoPendente = null;
        }

        function fecharModalNovoCliente() {
            document.getElementById('modalNovoCliente').style.display = 'none';
        }

        // ============================================
        // FUN√á√ÉO: Deletar cliente
        // ============================================
        async function deletarCliente(clienteId, event) {
            if (event) event.stopPropagation();
    
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return;
    
            if (!confirm(`‚ö†Ô∏è Tem certeza que deseja EXCLUIR permanentemente o cliente ${cliente.nome}?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
                return;
            }
    
            if (!confirm(`üî• CONFIRMA√á√ÉO FINAL:\nDigite "EXCLUIR" para confirmar:`)) {
                return;
            }
    
            try {
                // Deletar configura√ß√µes do cliente
                await db.collection('clientes').doc(clienteId).delete();
        
                // Deletar dados financeiros do cliente
                try {
                    await db.collection('dados_financeiros').doc(clienteId).delete();
                } catch (e) {
                    console.log('Dados financeiros n√£o encontrados');
                }
        
                adicionarLog(`üóëÔ∏è Cliente ${cliente.nome} exclu√≠do permanentemente`);
                alert('‚úÖ Cliente exclu√≠do com sucesso!');
        
                // Limpar sele√ß√£o atual se for o cliente deletado
                if (clienteAtual && clienteAtual.id === clienteId) {
                    clienteAtual = null;
                    alteracoesNaoSalvas = false;
            
                    // Desabilitar bot√µes
                    document.getElementById('btnEditar').disabled = true;
                    document.getElementById('btnBloquear').disabled = true;
                    document.getElementById('btnSalvar').disabled = true;
                    document.getElementById('btnVisualizar').disabled = true;
                    document.getElementById('btnCopiarLink').disabled = true;
                }
        
            } catch (error) {
                console.error('Erro ao deletar cliente:', error);
                alert('‚ùå Erro ao deletar cliente: ' + error.message);
            }
        }

        // ============================================
        // FUN√á√ÉO: Diagn√≥stico de conex√£o
        // ============================================
        async function diagnosticarConexao() {
            console.log('üîç Diagnosticando conex√£o Firebase...');
    
            try {
                // Teste 1: Escrever
                await db.collection('_test_').doc('connection_test').set({
                    timestamp: new Date().toISOString(),
                    test: 'ok'
                });
                console.log('‚úÖ Teste 1: Escrita funcionou');
        
                // Teste 2: Ler
                const testRead = await db.collection('_test_').doc('connection_test').get();
                console.log('‚úÖ Teste 2: Leitura funcionou', testRead.data());
        
                // Teste 3: Clientes
                const clientesSnapshot = await db.collection('clientes').limit(1).get();
                console.log(`‚úÖ Teste 3: Cole√ß√£o clientes acess√≠vel (${clientesSnapshot.size} documentos)`);
        
                alert('‚úÖ Todas as conex√µes est√£o funcionando!');
        
            } catch (error) {
                console.error('‚ùå Erro de conex√£o:', error);
                alert('‚ùå Erro de conex√£o:\n' + error.message);
            }
        }

        // ============================================
        // INICIALIZA√á√ÉO CORRETA
        // ============================================
        window.onload = function() {
            console.log('üöÄ Master App iniciado');
            carregarClientes();
            adicionarLog('üöÄ Master App iniciado - Controle total');
        };

        // ===============================
        // FIX DE ABAS (VISUAL / CONTE√öDO / FUN√á√ïES / C√ìDIGO)
        // ===============================

    
        // ===============================
        // LOGO (base64 comprimido) + PREVIEW
        // ===============================
        let logoTempBase64 = null;

        function abrirSeletorLogo() {
            if (!clienteAtual) return alert('Selecione um cliente primeiro!');
            document.getElementById('logoInput').click();
        }

        function setLogoPreview(dataUrl) {
            const img = document.getElementById('logoPreview');
            const ph = document.getElementById('logoDropPlaceholder');
            if (dataUrl) {
                img.src = dataUrl;
                img.style.display = 'block';
                ph.style.display = 'none';
            } else {
                img.removeAttribute('src');
                img.style.display = 'none';
                ph.style.display = 'block';
            }

            // tamb√©m aplica no preview do app do cliente
            const pImg = document.getElementById('previewLogoImg');
            const pPh = document.getElementById('previewLogoPlaceholder');
            if (pImg && pPh) {
                if (dataUrl) {
                    pImg.src = dataUrl;
                    pImg.style.display = 'block';
                    pPh.style.display = 'none';
                } else {
                    pImg.removeAttribute('src');
                    pImg.style.display = 'none';
                    pPh.style.display = 'block';
                }
            }
        }

        async function comprimirImagemParaDataURL(file) {
            // converte para JPEG/PNG redimensionando para no m√°x. 600px (lado maior)
            const bitmap = await createImageBitmap(file);
            const max = 600;
            const scale = Math.min(1, max / Math.max(bitmap.width, bitmap.height));
            const w = Math.round(bitmap.width * scale);
            const h = Math.round(bitmap.height * scale);

            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(bitmap, 0, 0, w, h);

            // tenta jpeg para reduzir peso
            const jpeg = canvas.toDataURL('image/jpeg', 0.85);

            // fallback: se ainda ficar muito grande, reduz qualidade
            if (jpeg.length > 900_000) {
                return canvas.toDataURL('image/jpeg', 0.70);
            }
            return jpeg;
        }

        async function processarArquivoLogo(file) {
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                alert('Escolha um arquivo de imagem (PNG/JPG/WebP).');
                return;
            }

            try {
                const dataUrl = await comprimirImagemParaDataURL(file);
                logoTempBase64 = dataUrl;
                setLogoPreview(dataUrl);
                alteracaoNaoSalva();
            } catch (e) {
                console.error(e);
                alert('N√£o consegui processar esse logo. Tente outra imagem.');
            }
        }

        function removerLogoCliente() {
            if (!clienteAtual) return alert('Selecione um cliente primeiro!');
            if (!confirm('Remover o logo deste cliente?')) return;
            logoTempBase64 = '';
            setLogoPreview(null);
            alteracaoNaoSalva();
        }

        // Drag & Drop
        (function habilitarDropLogo() {
            const area = document.getElementById('logoDropArea');
            const input = document.getElementById('logoInput');
            if (!area || !input) return;

            input.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                processarArquivoLogo(file);
                input.value = '';
            });

            ['dragenter','dragover'].forEach(ev => {
                area.addEventListener(ev, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    area.style.outline = '2px solid rgba(255,255,255,0.35)';
                });
            });
            ['dragleave','drop'].forEach(ev => {
                area.addEventListener(ev, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    area.style.outline = 'none';
                });
            });
            area.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files && e.dataTransfer.files[0];
                processarArquivoLogo(file);
            });
        })();

        // ===============================
        // CONVITES (gera token + link)
        // ===============================
        let ultimoConviteGerado = '';

        function gerarTokenConvite(tamanho = 10) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let out = '';
            for (let i = 0; i < tamanho; i++) out += chars[Math.floor(Math.random() * chars.length)];
            return out;
        }

        function gerarLinkConvite(token, clienteId) {
            const base = window.location.origin + window.location.pathname.replace('master_app.html','');
            // Importante: o appfinanceiro s√≥ abre quando recebe ?cliente=<ID>. 
            // Mantemos tamb√©m o token do convite para uso futuro (cadastro guiado/valida√ß√£o).
            return `${base}appfinanceiro.html?cliente=${encodeURIComponent(clienteId)}&convite=${encodeURIComponent(token)}`;
        }

        async function gerarConviteCadastro() {
            if (!clienteAtual) return alert('Selecione um cliente primeiro!');

            const token = gerarTokenConvite(12);
            const link = gerarLinkConvite(token, clienteAtual.id);

            try {
                await db.collection('convites').doc(token).set({
                    status: 'pendente',
                    criadoEm: new Date().toISOString(),
                    clienteIdVinculado: clienteAtual.id,
                    perfilSugerido: clienteAtual.perfil || 'PESSOAL/FAMILIAR'
                });

                ultimoConviteGerado = link;
                document.getElementById('ultimoConviteLink').value = link;
                document.getElementById('btnCopiarConvite').disabled = false;

                try { await navigator.clipboard.writeText(link); } catch (_) {}

                alert('‚úÖ Convite gerado e link copiado.\n\nEnvie esse link para o cliente: \n' + link);
                adicionarLog(`‚ú® Convite gerado para ${clienteAtual.nome}: ${token}`);
            } catch (e) {
                console.error(e);
                alert('N√£o consegui gerar o convite. Veja o Console (F12).');
            }
        }

        async function copiarUltimoConvite() {
            const link = document.getElementById('ultimoConviteLink').value || ultimoConviteGerado;
            if (!link) return alert('Ainda n√£o h√° convite gerado.');
            try { await navigator.clipboard.writeText(link); } catch (_) {}
            alert('‚úÖ Link copiado:\n\n' + link);
        }



// =========================
// PERFIL PF/PJ (UI simples)
// =========================
function aplicarPerfilUI() {
  const perfilEl = document.getElementById('perfilCliente');
  if (!perfilEl) return;

  const isPF = perfilEl.value === 'pf';

  const tc = document.getElementById('termoColaborador');
  const ta = document.getElementById('termoAcao');
  const tcl = document.getElementById('termoCliente');

  [tc, ta, tcl].forEach(el => {
    if (!el) return;
    el.disabled = isPF;
    el.style.opacity = isPF ? '0.75' : '1';
    el.style.cursor = isPF ? 'not-allowed' : 'text';
    if (isPF) {
      el.value = 'N√£o se aplica';
    } else {
      if (el.value === 'N√£o se aplica') el.value = '';
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  const perfilEl = document.getElementById('perfilCliente');
  if (perfilEl) {
    perfilEl.addEventListener('change', aplicarPerfilUI);
    aplicarPerfilUI();
  }
});

</script>
</body>
</html>
